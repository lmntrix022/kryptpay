services:
  # Backend API - NestJS
  - type: web
    name: kryptpay-api
    env: node
    plan: starter
    buildCommand: NODE_ENV= npm ci && npm run prisma:generate && npm run build
    startCommand: npm run prisma:migrate:deploy && node dist/main.js
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: DATABASE_URL
        fromDatabase:
          name: kryptpay-db
          property: connectionString
      # Redis Configuration
      # Use Upstash Redis (recommended - free tier available)
      # Get connection URL from https://upstash.com and set REDIS_URL manually in Render dashboard
      - key: REDIS_URL
        sync: false
        # Set this manually in Render dashboard after creating Upstash Redis:
        # Format: rediss://default:PASSWORD@HOST:6379 (avec 's' pour TLS)
        # Or use separate variables: REDIS_HOST, REDIS_PORT, REDIS_PASSWORD
      # JWT & Auth
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_ACCESS_EXPIRES_IN
        value: "900"
      - key: JWT_REFRESH_EXPIRES_IN
        value: "604800"
      - key: PASSWORD_RESET_TOKEN_TTL
        value: "900"
      - key: ADMIN_TOKEN
        generateValue: true
      # Encryption
      - key: DATA_ENCRYPTION_KEY
        generateValue: true
        # Note: Must be exactly 32 bytes (256 bits) base64 encoded
        # Generate with: openssl rand -base64 32
      # Rate Limiting
      - key: THROTTLE_TTL
        value: "60000"
      - key: THROTTLE_LIMIT
        value: "100"
      # Email (Resend)
      - key: EMAIL_ENABLED
        value: "true"
      - key: EMAIL_PROVIDER
        value: "resend"
      - key: EMAIL_FROM
        value: "noreply@kryptpay.io"
      - key: RESEND_API_KEY
        sync: false
        # Set this in Render dashboard
      # Stripe
      - key: STRIPE_SECRET_KEY
        sync: false
        # Set this in Render dashboard
      - key: STRIPE_PUBLISHABLE_KEY
        sync: false
        # Set this in Render dashboard
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
        # Set this in Render dashboard
      - key: STRIPE_CONNECT_REFRESH_URL
        sync: false
        # Set to: https://your-dashboard-url.render.app/connect/error
      - key: STRIPE_CONNECT_RETURN_URL
        sync: false
        # Set to: https://your-dashboard-url.render.app/connect/success
      # Moneroo
      - key: MONEROO_SECRET_KEY
        sync: false
        # Set this in Render dashboard
      - key: MONEROO_WEBHOOK_SECRET
        sync: false
        # Set this in Render dashboard
      # eBilling
      - key: EBILLING_USERNAME
        sync: false
        # Set this in Render dashboard
      - key: EBILLING_SHARED_KEY
        sync: false
        # Set this in Render dashboard
      - key: EBILLING_BASE_URL
        value: "https://stg.billing-easy.com/api/v1/merchant"
      - key: EBILLING_WEBHOOK_TOKEN
        sync: false
        # Set this in Render dashboard
      # SHAP (Payout)
      - key: SHAP_BASE_URL
        value: "https://staging.billing-easy.net/shap/api/v1/merchant"
      - key: SHAP_API_ID
        sync: false
        # Set this in Render dashboard
      - key: SHAP_API_SECRET
        sync: false
        # Set this in Render dashboard
      - key: SHAP_WEBHOOK_TOKEN
        sync: false
        # Set this in Render dashboard
      # App URL (for email links)
      - key: APP_URL
        sync: false
        # Set to: https://your-dashboard-url.render.app

  # Frontend Dashboard - Next.js
  - type: web
    name: kryptpay-dashboard
    env: node
    plan: starter
    rootDir: apps/dashboard
    buildCommand: NODE_ENV=production npm install && npm run build && cp -r .next/static .next/standalone/.next/static && cp -r public .next/standalone/public
    startCommand: cd .next/standalone && node server.js
    healthCheckPath: /
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: NEXT_PUBLIC_API_BASE_URL
        value: "https://kryptpay-api.onrender.com/v1"
        # Note: fromService ne peut pas ajouter /v1, donc on définit manuellement
        # Remplacez kryptpay-api par le nom réel de votre service API si différent

databases:
  # PostgreSQL Database
  - name: kryptpay-db
    databaseName: kryptpay
    user: kryptpay
    plan: free  # Nouveau plan gratuit (remplace 'starter' legacy)
    # Note: Le plan 'free' est gratuit avec limitations:
    # - 90 jours de rétention automatique
    # - Limité en stockage et connexions
    # Pour la production, considérez un plan payant (standard, pro)

# Redis (optional - you can use Upstash Redis or Redis Cloud instead)
# Uncomment if you want to use Render's Redis service
# Note: Render's Redis is a paid service
# For free tier, consider using Upstash Redis (https://upstash.com)
# - type: redis
#   name: kryptpay-redis
#   plan: starter
#   ipAllowList: []  # Allow connections from Render services only
